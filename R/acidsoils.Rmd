---
title: "Estimating acid soil distribution in cropland at the continental scale."
author: "Sebastian Palmas"
date: "2019-07-24"
output: pdf_document
---

```{r packages, message=FALSE}
library(ggplot2)
library(tidyverse)
```


```{r, engine = 'bash', echo = F, eval = FALSE}

#7z l ~/Downloads/acidsoils-20190723T082159Z-001.zip  #list files
#7z x -aoa	~/Downloads/acidsoils-20190723T082159Z-001.zip Data/
7z x -aoa	~/Downloads/acidsoils-20190723T082159Z-001.zip Data/

```


# Acid soils

With the help of [Google Earth Engine (GEE)](https://earthengine.google.com/) we can analyze any continental spatial data in seconds.

This code below estiamtes the amount of cropland with an estimated high acidity (pH < 5.6). It then summarises the results by country.

* We are using USGS-NASA cropland mask. We plan to update it to the [Copernicus Global Land Cover](http://lcviewer.vito.be/).
* We use africasoils pH prediction for the continent.
```{r packages, message=FALSE}
library(ggplot2)
library(tidyverse)
```

## Crop areas
```{r reading, message=FALSE}
  
#to solve some issues, the Koualou Area (UU), Halaib Triangle (SU) and the Halaib Triangle (UU) are ommited in the results
disputed <- c('UU', 'SU')

json <- jsonlite::fromJSON('../Data/croparea_bycountry.geojson')
crop <- json$features$properties %>% 
  mutate(croparea_km = sum/100/1000000) %>% # dividedby 100 because scale of copernicus was 0-100 (percentage, not proportion) #/1000000 from m2 to km2
  select(country_co, country_na, croparea_km) %>% 
  filter(!country_co %in% disputed)

json <- jsonlite::fromJSON('../Data/acidcroparea_bycountry.geojson')
acidcrop <- json$features$properties %>% 
  select(country_co, sum) %>% 
  full_join(crop, by = 'country_co') %>%
  mutate(acidcroparea_km = sum/100/1000000,
         propacidcroparea = acidcroparea_km / croparea_km,
         ) %>% 
  select(-sum) %>% 
  filter(!country_co %in% disputed)

```

## Population analysis
```{r population}
json <- jsonlite::fromJSON('../Data/pop_bycountry.geojson' )
pop <- json$features$properties %>% 
  mutate(pop = sum) %>% 
  select(country_co, pop)  %>% 
  filter(!country_co %in% disputed)

json <- jsonlite::fromJSON('../Data/popcrop_bycountry.geojson' )
popcrop <- json$features$properties %>% 
  mutate(pop_cropland = sum) %>% 
  select(country_co, pop_cropland)  %>% 
  filter(!country_co %in% disputed)

json <- jsonlite::fromJSON('../Data/popacidcrop_bycountry.geojson' )
popacidcrop <- json$features$properties %>% 
  mutate(pop_acidcropland = sum) %>% 
  select(country_co, pop_acidcropland)  %>% 
  filter(!country_co %in% disputed)

json <- jsonlite::fromJSON('../Data/meanpopacidcrop_bycountry.geojson' )
meanpopacidcrop <- json$features$properties %>% 
  mutate(densitypop_acidcropland = mean) %>% 
  select(country_co, densitypop_acidcropland)  %>% 
  filter(!country_co %in% disputed)

###Join all tables
acidsoils <- acidcrop %>% 
  full_join(pop, by = 'country_co') %>%
  full_join(popcrop, by = 'country_co') %>%
  full_join(popacidcrop, by = 'country_co') %>% 
  full_join(meanpopacidcrop, by = 'country_co')

```

## Computing some new columns
```{r newcolumns}
library(countrycode)
acidsoils <- acidsoils %>% 
  mutate(country_co = countrycode(country_co, "fips", "iso2c"))

#country code of South Sudan not in countrycode package
acidsoils$country_co[acidsoils$country_na == 'South Sudan'] <- 'SS'

#export values to a csv
acidsoils$propacidcroparea[is.nan(acidsoils$propacidcroparea)] <- NA
write_csv(acidsoils, '../Data/acidsoils_bycountry.csv', '')
head(acidsoils)

```


## Countries arranged by the estimated cropland area under acid soils 
```{r plot1, echo = FALSE, message=FALSE}
p2 <- ggplot(acidsoils %>% filter(acidcroparea_km > 0), aes(x = reorder(country_na, -acidcroparea_km), y = acidcroparea_km)) +
  geom_bar(stat = "identity") +
  ylab('Cropland area with high acidity (km2)') +
  theme(axis.text.x = element_text(angle = 90))+
  xlab('Country')
p2
```

## Percentage of country cropland under high acidiry
```{r perc, echo = FALSE}
p2 <- ggplot(acidsoils %>% filter(propacidcroparea > 0), aes(x = reorder(country_na, -propacidcroparea), y = propacidcroparea)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90))+
  ylab('Percertage of country cropland high acidity (%)') + xlab('Country')
p2
```

# Applications
* Estimate the amount of inputs required to increase pH to a certain level.
* With data on limestone production locations, we can estimate the cost of taking it to the farms,
* Make an analysis of prioritization of areas to increase yields.
